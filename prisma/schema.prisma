generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  user
  admin
}

enum AccountStatus {
  active
  disabled
  deleted
}

enum ParticipationStatus {
  enrolled
  in_progress
  completed
}

enum MembershipTier {
  turista
  explorador
  conquistador
}

model User {
  id          String        @id @default(uuid())
  firebaseUid String        @unique
  email       String?       @unique
  displayName String?
  role        UserRole      @default(user)
  status      AccountStatus @default(active)
  locale      String        @default("es-ES")

  // ── Profile ────────────────────────────
  profileImageUrl       String?
  profileImageUpdatedAt DateTime?

  // ── Membership ─────────────────────────
  membershipTier      MembershipTier @default(turista)
  membershipStartedAt DateTime?
  membershipEndsAt    DateTime?

  // ── Progress & Level ───────────────────
  level Int @default(1)
  xp    Int @default(0)

  // ── Points ─────────────────────────────
  pointsTotal          Int    @default(0)
  pointsThisWeek       Int    @default(0)
  pointsWeekKey        String @default("")
  pointsThisMonth      Int    @default(0)
  pointsMonthKey       String @default("")
  battlePointsTotal    Int    @default(0)
  challengePointsTotal Int    @default(0)

  // ── League ─────────────────────────────
  leagueId        String?
  league          League?   @relation(fields: [leagueId], references: [id])
  leagueRank      Int?
  leagueUpdatedAt DateTime?

  // ── Participation counters ─────────────
  battlesInProgressCount    Int @default(0)
  challengesInProgressCount Int @default(0)
  battlesEnrolledCount      Int @default(0)
  challengesEnrolledCount   Int @default(0)
  battlesCompletedCount     Int @default(0)
  challengesCompletedCount  Int @default(0)

  // ── Global user stats (manual / pgAdmin) ─
  battlesWonCount            Int     @default(0)
  distanceTraveledKm         Decimal @default(0.0) @db.Decimal(10, 2)
  nightBattlesCompletedCount Int     @default(0)
  citiesVisitedCount         Int     @default(0)
  monumentsVisitedCount      Int     @default(0)

  // ── Relations ──────────────────────────
  favoriteBattles    FavoriteBattle[]
  favoriteChallenges FavoriteChallenge[]
  userBattles        UserBattle[]
  userChallenges     UserChallenge[]
  userBadges         UserBadge[]
  userTrophies       UserTrophy[]

  // ── Timestamps ─────────────────────────
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ── Indexes ────────────────────────────
  @@index([leagueId])
  @@index([battlesWonCount])
  @@index([citiesVisitedCount])
}

model League {
  id        String @id @default(uuid())
  name      String
  level     Int
  minPoints Int?
  maxPoints Int?

  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Battle {
  id     String  @id @default(uuid())
  title  String
  active Boolean @default(true)

  favorites FavoriteBattle[]
  users     UserBattle[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Challenge {
  id     String  @id @default(uuid())
  title  String
  active Boolean @default(true)

  favorites FavoriteChallenge[]
  users     UserChallenge[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FavoriteBattle {
  id        String   @id @default(uuid())
  userId    String
  battleId  String
  user      User     @relation(fields: [userId], references: [id])
  battle    Battle   @relation(fields: [battleId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, battleId])
  @@index([userId])
  @@index([battleId])
}

model FavoriteChallenge {
  id          String    @id @default(uuid())
  userId      String
  challengeId String
  user        User      @relation(fields: [userId], references: [id])
  challenge   Challenge @relation(fields: [challengeId], references: [id])
  createdAt   DateTime  @default(now())

  @@unique([userId, challengeId])
  @@index([userId])
  @@index([challengeId])
}

model UserBattle {
  id       String @id @default(uuid())
  userId   String
  battleId String
  user     User   @relation(fields: [userId], references: [id])
  battle   Battle @relation(fields: [battleId], references: [id])

  status       ParticipationStatus
  joinedAt     DateTime            @default(now())
  startedAt    DateTime?
  completedAt  DateTime?
  pointsEarned Int                 @default(0)

  @@unique([userId, battleId])
  @@index([userId, status])
  @@index([battleId])
}

model UserChallenge {
  id          String    @id @default(uuid())
  userId      String
  challengeId String
  user        User      @relation(fields: [userId], references: [id])
  challenge   Challenge @relation(fields: [challengeId], references: [id])

  status       ParticipationStatus
  joinedAt     DateTime            @default(now())
  startedAt    DateTime?
  completedAt  DateTime?
  pointsEarned Int                 @default(0)

  @@unique([userId, challengeId])
  @@index([userId, status])
  @@index([challengeId])
}

model Badge {
  id             String  @id @default(uuid())
  titleKey       String
  descriptionKey String
  ruleType       String
  active         Boolean @default(true)

  imageKey  String
  sortOrder Int    @default(0)

  users     UserBadge[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([active, sortOrder])
}

model UserBadge {
  id       String   @id @default(uuid())
  userId   String
  badgeId  String
  user     User     @relation(fields: [userId], references: [id])
  badge    Badge    @relation(fields: [badgeId], references: [id])
  earnedAt DateTime @default(now())

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([userId, earnedAt])
  @@index([badgeId])
}

model Trophy {
  id             String  @id @default(uuid())
  titleKey       String
  descriptionKey String
  ruleType       String
  active         Boolean @default(true)

  imageKey  String
  sortOrder Int    @default(0)

  users     UserTrophy[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([active, sortOrder])
}

model UserTrophy {
  id       String   @id @default(uuid())
  userId   String
  trophyId String
  user     User     @relation(fields: [userId], references: [id])
  trophy   Trophy   @relation(fields: [trophyId], references: [id])
  earnedAt DateTime @default(now())

  @@unique([userId, trophyId])
  @@index([userId])
  @@index([userId, earnedAt])
  @@index([trophyId])
}
